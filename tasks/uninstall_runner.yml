---
- name: Stop and disable GitHub Actions Runner service
  systemd:
    name: "{{ runner_service }}"
    state: stopped
    enabled: no
  when: runner_service in services
  tags:
    - uninstall

- name: Remove GitHub Actions Runner service
  file:
    path: "{{ item }}"
    state: absent
  with_items:
    - "/etc/systemd/system/{{ runner_service }}"
    - "{{ runner_dir }}/.service"
  tags:
    - uninstall

- name: Reload systemd
  systemd:
    daemon_reload: yes
  tags:
    - uninstall

- name: Check GitHub Actions runner file
  stat:
    path: "{{ runner_dir }}/.runner"
  register: runner_file
  tags:
    - uninstall

- name: Unregister runner from the GitHub
  command: "./config.sh remove --token {{ registration.json.token }} --unattended"
  args:
    chdir: "{{ runner_dir }}"
  become: yes
  become_user: "{{ runner_user }}"
  no_log: "{{ hide_sensitive_logs }}"
  when: ansible_hostname in registered_runners.json.runners|map(attribute='name')|list and runner_file.stat.exists
  tags:
    - uninstall